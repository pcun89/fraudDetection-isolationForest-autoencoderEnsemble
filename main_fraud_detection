from __future__ import annotations
import os
import argparse
import json
from typing import Tuple, Optional, Dict, Any

import numpy as np
import pandas as pd
from sklearn.datasets import make_classification
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    roc_auc_score,
    precision_recall_curve,
    auc,
    confusion_matrix,
    classification_report,
)
import joblib
import torch
import torch.nn as nn
from torch.utils.data import DataLoader, TensorDataset
import torch.optim as optim
from tqdm import tqdm

# Constants
RANDOM_STATE = 42
ISO_MODEL_PATH = "iso_forest.joblib"
AE_MODEL_PATH = "autoencoder.pth"
SCALER_PATH = "scaler.joblib"

# -----------------------------
# Data utilities
# -----------------------------


def loadOrGenerateData(csvPath: Optional[str] = None, labelCol: str = "label", testSize: float = 0.3
                       ) -> Tuple[pd.DataFrame, pd.Series, pd.DataFrame, pd.Series]:
    """
    Load CSV with numeric features and a label column, or generate synthetic imbalanced dataset.
    Returns: X_train_df, y_train, X_test_df, y_test
    """
    if csvPath:
        df = pd.read_csv(csvPath)
        if labelCol not in df.columns:
            raise ValueError(f"Label column '{labelCol}' not found in CSV.")
        y = df[labelCol].values
        X = df.drop(columns=[labelCol])
    else:
        # synthetic imbalanced classification with rare fraud class
        X, y = make_classification(
            n_samples=5000,
            n_features=20,
            n_informative=8,
            n_redundant=2,
            n_clusters_per_class=1,
            weights=[0.99, 0.01],  # 1% fraud
            flip_y=0.01,
            random_state=RANDOM_STATE,
        )
        X = pd.DataFrame(X, columns=[f"f{i}" for i in range(X.shape[1])])
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=testSize, random_state=RANDOM_STATE, stratify=y)
    return X_train, pd.Series(y_train), X_test, pd.Series(y_test)
